/*BlackPHP (c)2022 - 2023 Edwin Fajardo.*/
function calc_row_total(t){var e=t.closest("tr").find(".row_quantity").val(),a=t.closest("tr").find(".row_price").val(),n=t.closest("tr").find(".row_total").find("span");""!=e||""==a||isNaN(a)?isNaN(e)||isNaN(a)||""==e||""==a?n.text("0.00"):n.text((e*a).toFixed(2)):n.text(parseFloat(a).toFixed(2))}function calc_bill_total(){var t=0;if($(".row_total").each(function(){var e=parseFloat($(this).find("span").text());isNaN(e)||(t+=e)}),$("#subtotal").val(format_number(t)),$("#iva").val(format_number(.13*t)),2==parseInt($("#bill_type").val())){var e=parseFloat($("#perception").val());(""==e||isNaN(e))&&(e=0),$("#total").val(format_number(1.13*t+e))}else $("#total").val(format_number(t));$("#paid_amount_input").trigger("change")}function check_generic(t,e){var a=t;$.ajax({method:"GET",url:url.module+"/generic_by_combo/"+e,dataType:"json"}).done(function(t){a.find(".row_generics").html(""),$.each(t,function(t,e){var n=$(document.createElement("div")),o=$(document.createElement("span"));o.text(e.product_name+":"),n.append(o);var c=$(document.createElement("select"));c.attr("name","generics[]"),n.append(c),a.find(".row_generics").append(n),$.each(e.options,function(t,e){var a=$(document.createElement("option"));a.attr("value",e.product_id),a.text(e.product_name),c.append(a)})})}).fail(function(){}).always(function(){})}function build_selectors(){$(".data_selector:not(.select2-hidden-accessible)").each(function(){var t=$(this);if(900>$(window).width()&&t.data("width","100%"),null!=json[t.data("source")]){("none"!=t.data("search")||"none"==t.data("default"))&&(item=$(document.createElement("option"))).appendTo(t);var e=$("html").first().attr("lang"),a={data:json[t.data("source")],dropdownAutoWidth:!0,placeholder:t.data("placeholder")||"",width:t.data("width")||"fit-content",language:e};"none"==t.data("search")&&(a.minimumResultsForSearch=1/0),t.select2(a),null!=t.data("value")&&(t.val(t.data("value")),t.trigger("change.select2"))}}),building_entry_selector&&$("#bill_type").trigger("change"),$(".entry_selector").trigger("change"),building_entry_selector=!1}content_height=200,$(function(){content_height=$(window).height()-$("#main_header").outerHeight()-$("#main_footer").outerHeight(),$(".list_options").length&&(content_height-=$(".list_options").outerHeight(),$(".path_container").length&&(content_height-=1)),$("#main_nav").length&&$("#main_nav").css("width")==$("#main_nav").parent().css("width")&&screen.width>=800&&(content_height-=$("#main_nav").outerHeight()),content_height>0&&($("#content_section").css("min-height",content_height+"px"),$(".content_viewer").css("height",content_height+"px")),$(".nav_link").each(function(){$(this).prop("href")==location.href&&$(this).addClass("nav_link_active")}),$(".nav_link").on("click",function(t){$(".nav_link_active").removeClass("nav_link_active"),$(this).addClass("nav_link_active")}),$("#user_link").on("click",function(){$("#main_aside").slideToggle("fast")}),$(".logout_button").on("click",function(){$.ajax({method:"GET",url:"User/logout/",dataType:"json"}).done(function(t){t.session?$.jAlert({title:"Error",content:"No se ha podido cerrar sesi\xf3n",theme:"red",autofocus:".jalert_accept",btns:[{text:"Aceptar",closeAlert:!0,theme:"red",class:"jalert_accept"}]}):location.href="/"}).fail(function(){$.jAlert({title:"Error",content:"No se ha podido cerrar sesi\xf3n",theme:"red",autofocus:".jalert_accept",btns:[{text:"Aceptar",closeAlert:!0,theme:"red",class:"jalert_accept"}]})})}),$("a").not(".link_exclude").on("click",function(t){t.preventDefault();var e=$(this).attr("href");if("#"==e)return!1;if("#alert"==e){var a=$(this).data("href");return $.jAlert({title:$(this).data("title")||!1,theme:$(this).data("theme")||"blue",iframe:a,size:{height:content_height+"px",width:"100%"},iframeHeight:content_height-41+"px",noPadContent:!0}),!1}if(0==e.indexOf("#")||$(this).prop("href")==location.href)return!1;0==e.indexOf("http")?window.open(e,"_blank"):window.location.href=e}),url=function t(){var e=$(location).attr("pathname");0==e.indexOf("/")&&(e=e.substring(1)),"/"==e.slice(-1)&&(e=e.substring(0,e.length-1));var a=e.split("/"),n={module:a[0],method:a[1],id:a[2],options:{}};if(a.length>3)for(i=2;i<a.length;i+=2)n.options[a[i]]=a[i+1];return n}(),connection_fails=0,setInterval(function t(){$.ajax({method:"POST",url:"Resources/keep_alive/",data:url,dataType:"json"}).done(function(t){t.alive?connection_fails=0:location.reload()}).fail(function(){++connection_fails>1&&location.reload()})},3e4),$(".link_button").on("click",function(){window.open($(this).data("href"),"_top")}),set_date_picker=function(){$(this).removeClass("hasDatepicker"),$(this).removeAttr("id"),$(this).datepicker({dateFormat:$(this).data("format")||"dd/mm/yy",monthNames:["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Deciembre"],dayNamesMin:["Dom","Lun","Mar","Mie","Jue","Vie","Sab"]})},$(".date_input").each(set_date_picker),window.onbeforeprint=function(){$(".content_viewer").css({"overflow-y":"auto",height:"auto"})},$(".menu_item").on("click",function(){$(this).css({opacity:"0.1",transform:"scale(2)"})}),$("#nav_content a").each(function(){(a_module=$(this).attr("href").replace("/",""))==url.module&&$(this).addClass("nav_link_active")}),$("body").on("keydown",t=>{("I"==t.key||"i"==t.key)&&t.altKey&&(location.href="/")}),$(document).tooltip(),$("#menu_button").on("click",function(){"#"==$(this).attr("href")&&$("#main_nav").slideToggle("slow")}),$("#tabs").accordion({collapsible:!0,heightStyle:"content",activate:function(){$("textarea").trigger("input")}}),$(".back_button").on("click",function(){history.back()})}),jQuery(function(t){t.extend({form:function(e,a,n){null==n&&(n="POST"),null==a&&(a={});var o=t("<form>").attr({method:n,action:e}).css({display:"none"}),c=function(e,a){if(Array.isArray(a))for(var n=0;n<a.length;n++)c(e+"[]",a[n]);else if("object"==typeof a)for(var l in a)a.hasOwnProperty(l)&&c(e+"["+l+"]",a[l]);else null!=a&&o.append(t("<input>").attr({type:"hidden",name:String(e),value:String(a)}))};for(var l in a)a.hasOwnProperty(l)&&c(l,a[l]);return o.appendTo("body")}})}),$(function(){function t(){null==url.method&&(url.method="listar");var t=url.module+"/"+url.method+"/";$.each(url.options,function(e,a){null!=a&&0!=a&&(t+=e+"/"+a+"/")}),location.href=t}function e(t){(div=$(document.createElement("div"))).css("width","720px"),div.html(t),$("body").append(div);var e=div.width(),a=div.height(),n=e+96,o=e,c=a,l=Math.ceil(a/1054)-1;html2canvas(div[0],{allowTaint:!0,scale:2}).then(function(t){t.getContext("2d"),console.log(t.height+"  "+t.width);var e=t.toDataURL("image/jpeg",1),a=new jsPDF("p","pt",[n,1054]);a.addImage(e,"JPG",48,48,o,c);for(var r=1;r<=l;r++)a.addPage(n,1054),a.addImage(e,"JPG",48,-(1054*r)+192,o,c);a.save("HTML-Document.pdf")}),div.remove()}null!=window.jspdf&&(window.jsPDF=window.jspdf.jsPDF),$(".data_viewer").each(function(){(function e(a){var n=$("#"+a),o=n.find(".template").clone().removeClass("template").prop("outerHTML");$.ajax({method:"POST",url:url.module+"/"+a+"_loader/",data:url,dataType:"json"}).done(function(e){var c=!0;if(null!=e.content&&(e.content.length>0&&(c=!1),$.each(e.content,function(t,e){var n=o;$.each(e,function(t,e){n=n.replace(RegExp("{{"+t+"}}","g"),e)}),$("#"+a+" tbody").append(n)}),$("#"+a+" tbody tr").on("click",function(){$(this).data("href")?location.href=$(this).data("href")+"/"+$(this).data("id")+"/":$(this).data("alert")&&$.jAlert({title:$(this).data("title")||!1,theme:$(this).data("theme")||"blue",iframe:$(this).data("alert"),size:{height:content_height+"px",width:"100%"},iframeHeight:content_height-41+"px",noPadContent:!0})}),e.foot&&$.each(e.foot,function(t,e){tr=(tr=$("#"+a+" tfoot").html()).replace(RegExp("{{"+t+"}}","g"),e),$("#"+a+" tfoot").html(tr)})),null!=e.found_rows){var l=0;l=null==url.options.page?e.found_rows>0?1:0:url.options.page,$(".pagination").jqPagination({paged:function(e){url.options.page=e,t()},max_page:Math.ceil(e.found_rows/100),current_page:l,page_string:"{current_page} / {max_page}"})}n.show(),c&&$(".empty_table_message").show(),n.data("type")||n.floatThead({scrollContainer:!0});var r=o.replaceAll(/\{\{[A-Za-z0-9_]+\}\}/g,"");for((r=$(r)).find("td").html("&nbsp;"),r.addClass("void_tr");n.outerHeight()+45<content_height;)$("#"+a+" tbody").append(r.clone());e.load_after&&$.each(e.load_after,function(t,e){$("."+t).text(e)})}).fail(function(){$("div.loading_error").show()}).always(function(){$("div.loading_data").hide()})})($(this).attr("id"))}),$(".data_table").each(function(){(function t(e){var a=$("#"+e),n=a.find(".template").clone().removeClass("template").prop("outerHTML");$.ajax({method:"POST",url:url.module+"/"+e+"_loader/",data:url,dataType:"json"}).done(function(t){null!=t.content&&($.each(t.content,function(t,a){var o=n;$.each(a,function(t,e){o=o.replace(RegExp("{{"+t+"}}","g"),e)}),$("#"+e+" tbody").append(o)}),$("#"+e+" tbody tr").on("click",function(t){$(this).data("href")&&(location.href=$(this).data("href")+"/"+$(this).data("id")+"/"),$(this).data("alert")&&$.jAlert({title:$(this).data("title")||!1,theme:$(this).data("theme")||"blue",iframe:$(this).data("alert"),size:{height:content_height+"px",width:"100%"},iframeHeight:content_height-41+"px",noPadContent:!0})}),t.foot&&$.each(t.foot,function(t,a){tr=(tr=$("#"+e+" tfoot").html()).replace(RegExp("{{"+t+"}}","g"),a),$("#"+e+" tfoot").html(tr)})),a.find("tr.template").remove();var o=a.DataTable({responsive:!0,paging:!1,fixedHeader:{header:!0,footer:!0},scrollY:$(".content_viewer").height()-65,language:{url:"/Resources/datatables_language/"+$("html").attr("lang")},dom:"lrtip"});t.load_after&&$.each(t.load_after,function(t,e){$("."+t).text(e)}),$(".data_search").on("keyup",function(){o.search($(this).val()).draw()})}).fail(function(){$("div.loading_error").show()}).always(function(){$("div.loading_data").hide()})})($(this).attr("id")),$(".content_viewer").css("overflow","hidden")}),$(".content_loader").each(function(){var t,a;t=$(this).attr("id"),a=$("#"+t),module=url.module||"index",$.ajax({method:"POST",url:module+"/"+t+"_loader/",data:url,dataType:"html"}).done(function(t){a.html(t),$(".menu_item").on("click",function(){$(this).css({opacity:"0.1",transform:"scale(2)"})}),$("#main_content").has(".details_content").addClass("details_main_content"),$(".close_details").on("click",function(t){t.preventDefault(),$(".details_content").css({opacity:"0.1",transform:"scale(0.1)"}),history.back()}),a.find(".link_button").on("click",function(){window.open($(this).data("href"),"_top")}),a.find(".alert_button").on("click",function(){var t=$(this).data("href");return $.jAlert({title:$(this).data("title")||!1,theme:$(this).data("theme")||"blue",iframe:t,size:{height:content_height+"px",width:"100%"},iframeHeight:content_height-41+"px",noPadContent:!0}),!1}),a.find(".print_button").on("click",function(){print_header=null,$(".print_header").length&&(print_header=$(".print_header").html()),print_footer=null,$(".print_footer").length&&(print_footer=$(".print_footer").html()),$($(this).data("print")).printThis({loadCSS:$(this).data("css")||"",header:print_header,footer:print_footer})}),a.find(".pdf_button").on("click",function(){var t="",a="";$(".print_header").length&&(a=$(".print_header").html());var n="";$(".print_footer").length&&(n=$(".print_footer").html()),t=a+$($(this).data("content")).html()+n,e(t)}),a.find(".filter_button").on("click",function(){$(".action_filter").toggle("slow")}),$(".open_dialog_button").on("click",function(){$("#"+$(this).data("dialog")).dialog("open")}),$(".delete_button").length&&$(".delete_button").on("click",delete_button_click),a.find(".data_viewer").show(),$(".link_row").on("click",function(){"#"!=$(this).data("href")&&(location.href=$(this).data("href"))}),$(".myChart").length>0&&init_chart()}).fail(function(){$("div.loading_error").show()}).always(function(){$("div.loading_data").hide()})}),$(".data_viewer").length&&$(".data_search").on("keyup",function(){var t=$(this).val();$(".data_viewer tbody tr").not(".template").each(function(){found=!1,$(this).find("td").each(function(){$(this).text().toUpperCase().indexOf(t.toUpperCase())>=0&&(found=!0)}),found?$(this).show():$(this).hide()})}),$(".data_filter").each(function(){var e,a,n;$(this).is("select")?(e=$(this).attr("id"),a=url.module||"index",n=$("#"+e),null!=n.data("module")&&(a=n.data("module")),$.ajax({method:"POST",url:a+"/"+e+"_loader/",data:url,dataType:"json"}).done(function(e){if(e.results){var a=screen.width<750?"100%":"fit-content",o={data:e.results,dropdownAutoWidth:!0,placeholder:n.data("placeholder")||"",width:n.data("width")||a};("none"!=n.data("search")||"none"==n.data("default"))&&(item=$(document.createElement("option"))).appendTo(n),"none"==n.data("search")&&(o.minimumResultsForSearch=1/0),n.select2(o),null!=n.data("value")&&(n.val(n.data("value")),n.trigger("change.select2")),n.data("identifier")&&(url.options[n.data("identifier")]&&(n.val(url.options[n.data("identifier")]),n.trigger("change.select2")),n.on("change",function(){url.options[n.data("identifier")]=n.val(),n.data("reset")&&(fields=n.data("reset").split(","),$.each(fields,function(){url.options[this]&&(url.options[this]=null)})),t()}))}}).fail(function(){n.hide()}).always(function(){})):$(this).on("change",function(){$(this).is(".date_input")&&($(this).data("value",$(this).val()),$(this).val($.datepicker.formatDate("yy-mm-dd",$(this).datepicker("getDate")))),url.options[$(this).data("identifier")]=$(this).val(),t()})}),$(".filter_button").on("click",function(){$(".action_filter").toggle("slow")}),$(".download_link").on("click",function(){$.form($(this).data("url"),url).submit()}),$(".print_button").on("click",function(){$(".data_viewer").length>0&&$($(this).data("print")).floatThead("destroy");var t=null;$(".print_header").length&&(t=$(".print_header").html());var e=null;$(".print_footer").length&&(e=$(".print_footer").html());var a="";(".data_viewer"==$(this).data("print")||".data_table"==$(this).data("print"))&&(a="public/styles/print_list.css?r="+Math.floor(1e5*Math.random())),void 0!==$($(this).data("print")).data("css")&&(a=$($(this).data("print")).data("css")),$($(this).data("print")).printThis({loadCSS:a,header:t,footer:e})}),$(".pdf_button").on("click",function(){$(".data_viewer").length>0&&$($(this).data("print")).floatThead("destroy");var t="",a="";$(".print_header").length&&(a=$(".print_header").html());var n="";$(".print_footer").length&&(n=$(".print_footer").html()),t=a,$($(this).data("content")).each(function(){t+=$(this).html()}),e(t+=n)})}),bill_type=1,$(function(){$(".row_quantity, .row_price").on("change",function(){calc_row_total($(this)),calc_bill_total()}),$("#perception").on("change",function(){calc_bill_total()}),$("#bill_type").on("change",function(){var t=$(this).val();if(2==t){$("#vat_total, #subtotal_div, #perception_total").show();var e=$(".items_container .row_price").toArray();$.each(e,function(){var t=$(this);t.data("nvat_price")&&(t.val(t.data("nvat_price")),t.trigger("change"))})}else{$("#vat_total, #subtotal_div, #perception_total").hide();var e=$(".items_container .row_price").toArray();$.each(e,function(){var t=$(this);t.data("sale_price")&&(t.val(t.data("sale_price")),t.trigger("change"))})}var a=$(this).select2("data")[0];a&&(a.next&&$("#bill_number").val(a.next),a.max_items&&($(".items_container").data("max_items",a.max_items),0!=a.max_items&&$(".items_container tr").length>a.max_items&&Swal.fire({title:"Advertencia",html:"Ya ha registrado m\xe1s art\xedculos de los permitidos para este tipo de documento",icon:"warning",confirmButtonText:"Acceptar"}))),""==t&&JSON.ticket++,bill_type=t}),$("#paid_amount_input").on("change",function(){var t=parseFloat($(this).val()),e=$("#total").val();e=parseFloat(e.replace(",",""));var a=t-e;isNaN(a)?$("#change_input").val(""):$("#change_input").val(a.toFixed(2))})}),building_entry_selector=!0,$(function(){function t(t){t.fadeIn(),setTimeout(function(){t.fadeOut("slow")},5e3)}function e(t){if(13==t.which){var n=$(this).closest("tbody");if(n.is(".locked_tbody"))return!1;if($(this).closest("tr").is(":last-child")){var o=n.data("max_items");if(null!=o&&0!=o&&n.find("tr").length>=o)return!1;var c=$(this).closest("tr").find(".row_price");c.removeAttr("data-sale_price"),c.removeAttr("data-nvat_price");var l=$(this).closest("tr").find(".row_product_name");if(""==l.val())return l.trigger("focus"),!1;if(""==c.val())return c.trigger("focus"),!1;$(this).closest("tr").find(".data_selector").each(function(){$(this).select2("destroy")});var u=$(this).closest("tr").clone();n.append(u),u.find(".row_count").text(n.find("tr").length),u.find("input").first().trigger("focus"),u.find("input").val(""),u.find("textarea").val(""),u.find(".row_number").val(n.find("tr").length-1),u.find(".clearable").text(""),u.find(".date_input").each(set_date_picker),u.find("input").on("keypress",e),u.find(".row_quantity, .row_price").on("change",function(){calc_row_total($(this)),calc_bill_total()}),u.find(".row_total").find("span").text("0.00"),u.find(".delete_row_icon").on("click",delete_row_click),n.find(".delete_row_icon").css({visibility:"visible"}),u.find(".complete_value").text(""),u.find(".complete_value").on("click",s),u.find(".partial_value").show(),u.find(".partial_value").on("blur",r),u.find(".partial_value").on("change",d),u.find(".row_generics").text(""),u.find(".local_code").on("change",h),a(u),build_selectors()}return!1}}function a(t=$("body")){t.find(".list_input").each(function(){var t=json[$(this).data("source")].map(function(t){return null==t.label&&(t.label=t.text),t});$(this).autocomplete({source:t,select:function(t,e){if(e.item.id||e.item.local_code){var a=$(this).closest(".autocomplete_container");0==a.length&&(a=$(this).closest("tr")),$.each(e.item,function(t,e){a.find("input."+t).val(e),a.find("textarea."+t).val(e),a.find("select."+t).data("value",e),a.find("span."+t).text(e)}),bill_type&&2==bill_type&&"Sales"==url.module&&a.find(".sale_price").val(e.item.nvat_price),e.item.sale_price&&e.item.nvat_price&&(a.find(".sale_price").attr("data-sale_price",e.item.sale_price),a.find(".sale_price").attr("data-nvat_price",e.item.nvat_price)),a.find(".row_available").text(e.item.quantity),""==a.find(".row_quantity").val()&&a.find(".row_quantity").val(1),calc_row_total(a),calc_bill_total(),e.item.combo_id?setTimeout(check_generic,50,a,e.item.combo_id):a.find(".row_generics").html("")}},change:function(t,e){e.item||($(this).val(""),$(this).trigger("change"))},autoFocus:!0}),$(this).on("click",function(){$(this).trigger("select")})}),t.find(".data_completion").each(function(){if($(this).data("source")){var t=json[$(this).data("source")].map(function(t){return null==t.label&&(t.label=t.text),t});$(this).autocomplete({source:t,select:function(t,e){var a=$(this).data("id");e.item.id?$(".data_completion").each(function(){$(this).data("id")==a&&$(this).data("field")&&e.item[$(this).data("field")]&&$(this).val(e.item[$(this).data("field")])}):$(".data_completion").each(function(){$(this).data("id")==a&&$(this).data("field")&&$(this).val("")})},change:function(t,e){if(!e.item){var a=$(this).data("id");$(".data_completion").each(function(){$(this).data("id")==a&&$(this).data("field")&&$(this).val("")})}},autoFocus:!0}),$(this).on("click",function(){$(this).trigger("select")})}})}function n(){$.ajax({method:"POST",url:deletion_url,data:url,dataType:"json"}).done(function(t){t.deleted?$.jAlert({title:t.title||"Success",content:t.message||"Deleted succesfully!",theme:"blue",autofocus:".jalert_accept",btns:[{text:t.accept||"OK",closeAlert:!0,theme:"blue",class:"jalert_accept",onClick:function(){window.open(deletion_next,"_top")}}]}):t.message?$.jAlert({title:t.title||"Message",content:t.message,theme:t.theme||"red",autofocus:".jalert_accept",btns:[{text:t.accept||"OK",closeAlert:!0,theme:t.theme||"red",class:"jalert_accept"}]}):$.jAlert({title:"Error",content:"Failed to delete.",theme:"red",autofocus:".jalert_accept",btns:[{text:"Aceptar",closeAlert:!0,theme:"red",class:"jalert_accept"}]})}).fail(function(){}).always(function(){})}function o(t){null==last_form||t.no_reset||(last_form.trigger("reset"),last_form.find(".data_selector").val("").trigger("change"),last_form.find(".clearable").text(""),last_form.find(".deletable").not(":first").remove())}function c(t){t.preventDefault(),delete_button=$(this),$.jAlert({title:"Confirmar",content:"\xbfEst\xe1 seguro de que desea eliminar la entrada?",theme:"red",autofocus:".jalert_cancel",btns:[{text:"Aceptar",closeAlert:!0,theme:"red",class:"jalert_accept",onClick:function(){delete_button.closest(".form_entry").remove()}},{text:"Cancelar",closeAlert:!0,theme:"darkgray",class:"jalert_cancel"}]})}function l(){selected=[],$(".unique_selection").each(function(){selected[selected.length]=$(this).val()}),$(".unique_selection option").each(function(){$(this).removeAttr("disabled")}),$(".unique_selection").each(function(){selected_val=$(this).val(),(selector=$(this)).find("option").each(function(){$.inArray($(this).val(),selected)>=0&&selected_val!=$(this).val()&&$(this).attr("disabled",!0)}),selector.select2()})}function r(){$(this).val().length>0&&($(this).siblings(".complete_value").text($(this).val()),$(this).siblings(".complete_value").css("display","block"),$(this).hide())}function s(){var t=$(this).siblings(".partial_value").first();t.show(),t.trigger("focus"),t.trigger("select"),$(this).css("display","none")}function d(){$(this).siblings(".complete_value").text($(this).val()),0==$(this).val().length&&($(this).siblings(".complete_value").hide(),$(this).show())}function h(){var t=$(this).val().toLowerCase().trim();if(""==t)return!1;t=t.replace("\r","");var e=$(this).closest("tr").find(".list_input"),a=json[e.data("source")];$.each(a,function(a,n){(n.local_code.toLowerCase()==t||n.barcode.toLowerCase()==t)&&0==parseInt(n.pres_id)&&(e.val(n.element_name),e.data("ui-autocomplete")._trigger("select","autocompleteselect",{item:n}))})}new_item_row=$(".item_row").first().clone(!0),json=[],action_module="index",null!=url.module&&""!=url.module&&(action_module=url.module),$("#main_content").has(".form_content").addClass("form_main_content"),$.ajax({method:"POST",url:action_module+"/load_form_data/",data:url,dataType:"json"}).done(function(t){if((json=t).items&&($(".items_container").each(function(){var t=$(this);if(json.items[t.data("source")]&&json.items[t.data("source")].length>0){var n=t.find("tr").first().clone(!0);t.find("tr:first").first().remove(),row_count=0,$.each(json.items[t.data("source")],function(o,c){var l=n.clone(!1);l.find(".date_input").each(set_date_picker),l.find("input").on("keypress",e),l.find(".row_quantity, .row_price").on("change",function(){calc_row_total($(this)),calc_bill_total()}),l.find(".delete_row_icon").on("click",delete_row_click),a(l),l.find(".row_number").val(row_count),l.find(".row_count").text(++row_count),l.find(".row_available").text(c.available),l.find(".row_quantity").val(c.quantity),$.each(c,function(t,e){l.find("input."+t).val(e),l.find("textarea."+t).val(e),l.find("select."+t).data("value",e),l.find("span."+t).text(e),l.find("div."+t).text(e)}),calc_row_total(l),t.append(l),l.find("input").first().trigger("focus"),l.find(".complete_value").on("click",s),l.find(".complete_value").css("display","block"),l.find(".partial_value").hide(),l.find(".partial_value").on("blur",r),l.find(".partial_value").on("change",d),l.find(".row_generics").text("")}),row_count>1&&$(".delete_row_icon").css({visibility:"visible"})}}),"function"==typeof start_calc_consumption&&start_calc_consumption(),$(".current").trigger("change")),json.update&&($(".update_input").each(function(){json.update[$(this).attr("name")]&&($(this).val(json.update[$(this).attr("name")]),$(this).data("value",json.update[$(this).attr("name")])),null!=$(this).data("cat_source")&&($(this).data("default_value",json.update[$(this).attr("name")]),$(this).data("default_cat",json.update[$($(this).data("cat_source")).attr("name")]))}),$(".update_radio").each(function(){json.update[$(this).attr("name")]==$(this).attr("value")?$(this).attr("checked","checked"):$(this).removeAttr("checked")}),$(".update_ucheck").each(function(){1==parseInt(json.update[$(this).attr("name")])?$(this).attr("checked","checked"):$(this).removeAttr("checked")}),$(".update_text").each(function(){$(this).text(json.update[$(this).data("id")])})),$(".age_input").trigger("change"),json.check&&$(".update_check").each(function(){var t=$(this);if(json.check[t.data("source")]){var e=!1;$.each(json.check[t.data("source")],function(a,n){n.id==t.attr("value")&&(t.attr("checked","checked"),e=!0)}),e||t.removeAttr("checked")}}),null!=json.found_rows){var n=0,o=json.page_size||100;n=null==url.options.page?json.found_rows>0?1:0:url.options.page,$(".pagination").jqPagination({paged:function(t){url.options.page=t,null==url.method&&(url.method="listar"),href=url.module+"/"+url.method+"/",$.each(url.options,function(t,e){null!=e&&(href+=t+"/"+e+"/")}),location.href=href},max_page:Math.ceil(json.found_rows/o),current_page:n,page_string:"{current_page} / {max_page}"})}build_selectors(),a(),calc_bill_total(),$(".unique_selection").on("change",function(){setTimeout(l,500)}),l(),$("textarea").trigger("input")}).fail(function(){}).always(function(){}),close_dialog=null,add_selector=null,last_form=null,duplicate=!1,$("form").on("submit",function(e){if(e.preventDefault(),duplicate)return!1;if(duplicate=!0,setTimeout(function(){duplicate=!1},5e3),a="",n=!0,$(".equal_value").each(function(){""==a?a=$(this).val():$(this).val()!=a&&($.jAlert({title:"Error",content:"Las contrase\xf1as no coinciden",theme:"red",autofocus:".jalert_accept",btns:[{text:"Aceptar",closeAlert:!0,theme:"red",class:"jalert_accept"}]}),n=!1)}),!n)return!1;var a,n,c=$(this).attr("action")||"save";$(this).find(".date_input").each(function(){$(this).data("value",$(this).val()),$(this).val($.datepicker.formatDate("yy-mm-dd",$(this).datepicker("getDate")))});var l=new FormData(this);first_input=$(this).find("input").first(),div_sending=$(this).siblings(".sending"),div_success=$(this).siblings(".success"),div_error=$(this).siblings(".error"),div_sending.show(),close_dialog=$(this).data("close_dialog"),add_selector=$(this).data("selector"),last_form=$(this),null!=$(this).data("module")&&(action_module=$(this).data("module"));var r={xhr:function(){var t=new window.XMLHttpRequest;return t.upload.addEventListener("progress",function(t){if(t.lengthComputable){var e=t.loaded/t.total*100;$(".progress-bar").width(e+"%"),$(".progress-bar").html(e+"%")}},!1),t},beforeSend:function(){$(".progress-bar").width("0%"),$(".progress-bar").html("0%")},method:"POST",url:action_module+"/"+c+"/",data:l,dataType:"json",processData:!1,contentType:!1};$.ajax(r).done(function(e){var a,n;e.message&&Swal.fire({title:e.title,html:e.message,icon:"green"==e.theme?"success":"red"==e.theme?"error":"info",didDestroy:function(){first_input.focus(),e.reload_after&&location.reload(),e.print_after&&($(".form_body").printThis(),$(".reload_button").show(),$(".reload_button").siblings().hide()),e.redirect_after&&(o(e),location.href=e.redirect_after)},confirmButtonText:e.accept||"Accept"}),e.success||e.saved?(a=e,n=div_success,n.fadeIn(),null!=add_selector&&(source=$("#"+add_selector).data("source"),json[source][json[source].length]=a,$("#"+add_selector).select2({data:json[source]}),$("#"+add_selector).val(a.id).trigger("change")),null==close_dialog||a.reload_after?setTimeout(function(){n.fadeOut("slow")},5e3):($("#"+close_dialog).dialog("close"),close_dialog=null),o(a)):null!=e.next?(o(e),location.href=e.next):e.reload?location.reload():t(div_error)}).fail(function(){t(div_error)}).always(function(){div_sending.hide(),$(".date_input").each(function(){null!=$(this).data("value")&&($(this).val($(this).data("value")),$(this).removeAttr("data-value"))})})}),$("form .cancel_button").on("click",function(){$(this).closest("form").data("reset")&&($(".form_content").css({opacity:"0.1",transform:"scale(0.1)"}),history.back())}),$(".close_form").on("click",function(t){t.preventDefault(),$(".form_content").css({opacity:"0.1",transform:"scale(0.1)"}),history.back()}),$(".details_table input").on("keypress",e),format_number=function(t){var e;return new Number(t).toLocaleString("en-US",{style:"currency",currency:"USD"}).slice(1).replace(",","")},$(".classifier_input").on("change",function(){$(".content_viewer").css("visibility","hidden"),$(".classifier_button").show(),$(".print_button").hide(),$(".data_search").hide()}),delete_button_click=function(){deletion_url=$(this).data("url"),deletion_next=$(this).data("next"),$.jAlert({title:"Confirmar",content:"\xbfConfirma que desea borrar este registro?",theme:"red",autofocus:".jalert_cancel",btns:[{text:"Confirmar",closeAlert:!0,theme:"red",class:"jalert_accept",onClick:n},{text:"Cancelar",closeAlert:!0,theme:"gray",class:"jalert_cancel"}]})},$(".delete_button, .delete_link").on("click",delete_button_click),$(".reload_button").on("click",function(){location.reload()}),delete_row_click=function(t){if(t.preventDefault(),delete_button=$(this),(row_count=(tbody=$(this).closest("tbody")).find("tr").length)<2)return!1;$.jAlert({title:"Confirmar",content:"\xbfEst\xe1 seguro de que desea eliminar la fila?",theme:"red",autofocus:".jalert_cancel",btns:[{text:"Aceptar",closeAlert:!0,theme:"red",class:"jalert_accept",onClick:function(){null!=(product_id=delete_button.closest("tr").find(".product_id").val())&&""!=product_id&&(removed=delete_button.closest("tr").find(".item_id").val(),(input=$(document.createElement("input"))).val(removed),input.attr("name","removed[]"),input.attr("type","hidden"),delete_button.closest("form").append(input)),delete_button.closest("tr").remove(),calc_bill_total(),row_count=0,tbody.find(".row_count").each(function(){$(this).text(++row_count)}),row_number=0,tbody.find(".row_number").each(function(){$(this).val(row_number++)}),(row_count=tbody.find("tr").length)<2&&tbody.find(".delete_row_icon").css({visibility:"hidden"})}},{text:"Cancelar",closeAlert:!0,theme:"darkgray",class:"jalert_cancel"}]})},$(".delete_row_icon").on("click",delete_row_click),$(".code_generator").on("change",function(){var t=$(this).select2("data")[0],e=$($(this).data("code_input"));null!=e.data("default_cat")&&t.id==e.data("default_cat")?e.val(e.data("default_value")):null!=t.next&&e.val(""+t.category_prefix+t.next+t.category_suffix)}),$(".add_row_button").on("click",function(){var t=$($(this).data("tbody"));null==t&&(t=$(".items_container").first());var n=t.data("max_items");if(null!=n&&0!=n&&t.find("tr").length>=n)return!1;var o=t.find("tr").last();o.find(".data_selector").each(function(){$(this).select2("destroy")}),_tr=o.clone(),t.append(_tr),_tr.find(".row_count").text(t.find("tr").length),_tr.find("input").first().focus(),_tr.find("input").val(""),_tr.find("textarea").val(""),_tr.find(".row_number").val(t.find("tr").length-1),_tr.find(".date_input").each(set_date_picker),_tr.find("input").keypress(e),_tr.find(".row_price").removeAttr("data-sale_price"),_tr.find(".row_price").removeAttr("data-nvat_price"),_tr.find(".row_quantity, .row_price").change(function(){calc_row_total($(this)),calc_bill_total()}),_tr.find(".row_total").find("span").text("0.00"),_tr.find(".delete_row_icon").click(delete_row_click),_tr.find(".clearable").text(""),t.find(".delete_row_icon").css({visibility:"visible"}),_tr.find(".complete_value").text(""),_tr.find(".complete_value").click(s),_tr.find(".row_generics").text(""),_tr.find(".partial_value").show(),_tr.find(".partial_value").blur(r),_tr.find(".partial_value").change(d),_tr.find(".local_code").change(h),_tr.find("td").removeClass("td_active"),_tr.find("td").on("click",function(){td_active&&td_active.removeClass("td_active"),(td_active=$(this)).addClass("td_active")}),_tr.find("input").on("focus",function(){td_active&&td_active.removeClass("td_active"),(td_active=$(this).closest("td")).addClass("td_active")}),a(_tr),build_selectors()}),$(".add_entry_button").on("click",function(){var t=$($(this).data("container")),e=t.find(".form_entry").last();e.find(".data_selector").each(function(){$(this).data("value",$(this).val()),$(this).select2("destroy")});var n=e.clone();t.append(n),n.find(".entry_count").text(t.find(".form_entry").length),n.find("input").first().trigger("focus"),n.find("input, select, textarea").val(""),n.find(".date_input").each(set_date_picker),n.find(".delete_entry_icon").on("click",c),n.find(".extra_data").text(""),$(".delete_entry_icon").css({visibility:"visible"}),a(n),build_selectors(),n.find(".image-upload").each(function(){$(this).imageReader()}),n.find(".image-preview").html("")}),$(".delete_entry_icon").on("click",c),$(".input-images").length&&$(".input-images").imageUploader({label:"Arrastre aqu\xed una imagen, o haga click para buscarla.",maxFiles:1}),$(".entry_selector").on("change",function(t){var e=$(t.target).val(),a=$(".hidden_entry"),n=$(".entry_type_"+e);if(null!=$(this).data("target")){var o=$($(this).data("target"));a=o.find(".hidden_entry"),n=o.find(".entry_type_"+e)}a.hide(),a.find("input").each(function(){building_entry_selector||$(this).val(""),$(this).removeAttr("required")}),a.find("select").each(function(){building_entry_selector||$(this).val(""),$(this).removeAttr("required")}),n.show(),$(n).find("input").each(function(){null!=$(this).data("required")&&$(this).attr("required",!0)}),$(n).find("select").each(function(){null!=$(this).data("required")&&$(this).attr("required",!0)})}),$(".entry_selector").each(function(){var t=$(".entry_type_"+$(this).data("default"));(t=null!=$(this).data("target")?$($(this).data("target")).find(".entry_type_"+$(this).data("default")):$(".entry_type_"+$(this).data("default"))).show()}),$("textarea").each(function(){min_height=30,(min_height=this.scrollHeight>this.style.height?this.scrollHeight:this.style.height)<30&&(min_height=30),this.setAttribute("style","height:"+min_height+"px;")}).on("input",function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"}),$(".age_input").on("change",function(){if(""==$(this).val())return!0;date=$.datepicker.formatDate("yy-mm-dd",$(this).datepicker("getDate")),age_span=$(this).next("span"),$.ajax({method:"GET",url:"Resources/age_calculation/"+date,dataType:"json"}).done(function(t){t.age&&age_span.text(t.age)}).fail(function(){}).always(function(){})}),$(".partial_value").on("blur",r),$(".complete_value").on("click",s),$(".partial_value").on("change",d),$(".image-upload").each(function(){$(this).imageReader()}),$(".local_code").on("change",h),$(".details_table").length&&$(".data_search").on("keyup",function(){var t=$(this).val();$(".details_table tbody tr").not(".template").each(function(){found=!1,$(this).find("td").each(function(){$(this).text().toUpperCase().indexOf(t.toUpperCase())>=0&&(found=!0)}),found?$(this).show():$(this).hide()})}),$(".interval_start, .interval_end").on("change",function(){var t=$(".interval_start").datepicker("getDate"),e=$(".interval_end").datepicker("getDate"),a="";t<=e&&(a=(e-t)/864e5+1),$(".interval_count").text(a)}),td_active=null,$(".details_table tbody td").on("click",function(){td_active&&td_active.removeClass("td_active"),(td_active=$(this)).addClass("td_active")}),$(".details_table tbody td input").on("focus",function(){td_active&&td_active.removeClass("td_active"),(td_active=$(this).closest("td")).addClass("td_active")}),$(".check_table").on("click",function(t){t.preventDefault();var e=$(this).data("table");if(!e)return!1;var a=void 0==$(this).data("status")||"checked"==$(this).data("status");$(this).data("status",a?"unchecked":"checked"),$("#"+e).find("input:checkbox:not(:disabled)").each(function(){$(this).attr("checked",!a)}),$("#"+e).find(".check_row").each(function(){$(this).data("status",a?"unchecked":"checked")})}),$(".check_row").on("click",function(t){t.preventDefault();var e=void 0==$(this).data("status")||"checked"==$(this).data("status");$(this).data("status",e?"unchecked":"checked"),$(this).closest("tr").find("input:checkbox:not(:disabled)").each(function(){$(this).attr("checked",!e)})})}),$(function(){dialog_width=500,600>$(window).width()&&(dialog_width=-1!=navigator.userAgent.indexOf("AppleWebKit")?"-webkit-fill-available":"-moz-available"),$.extend($.ui.dialog.prototype.options,{modal:!0,autoOpen:!1,show:{effect:"explode",duration:500},hide:{effect:"explode",duration:500},width:dialog_width,maxWidth:500,open:function(){$("#container").css("opacity","0.2")},close:function(){var t=$(this).find("form");t.trigger("reset"),$("#container").css("opacity","1"),t.find("select").trigger("change.select2")}}),$.ui.dialog.prototype._allowInteraction=function(t){return!0},$(".open_dialog_button").on("click",function(){$("#"+$(this).data("dialog")).dialog("open")}),$(".dialog").each(function(){options={buttons:[{text:$(this).data("accept")||"Accept",click:function(t){$(this).find('button[type="submit"]').trigger("click")}},{text:$(this).data("close")||"Close",click:function(){$(this).dialog("close")}}]},$(this).dialog(options),$(this).data("reload")&&$(this).dialog("option","close",function(){location.reload()})})}),$(function(){function t(){var t=0;$(".order_item").each(function(){var e=$(this).find(".price_input").val()*$(this).find(".quantity_input").val();t+=e}),$("#form_total").text(t.toFixed(2))}$(".price_input, .quantity_input").on("change",t),$(".order_item a").on("click",function(){var e=$(this).parent().find(".quantity_input"),a=""==e.val()?0:parseInt(e.val());e.val(a+1),t()})}),$(function(){$(".parent_checkbox").on("click",function(){$(this).closest(".parent_item").find(".child_checkbox").prop("checked",$(this).prop("checked"))}),$(".child_checkbox").on("click",function(){var t=$(this).closest(".parent_item").find(".parent_checkbox"),e=$(this).closest(".children_container");$(this).prop("checked")?t.prop("checked",!0):0==e.find("input:checked").length&&t.prop("checked",!1)}),screen.width>=800&&$(".children_container").sortable()}),$(function(){init_chart=function(){$(".myChart").each(function(){var t,e,a,n;t=$(this),e=new Chart(t,{type:"bar",data:{labels:t.data("labels").split(","),datasets:[{label:"Metros c\xfabicos",data:t.data("data").split(","),backgroundColor:["#666","#666","#666","#666","#666","#666"]}]},options:{scales:{y:{beginAtZero:!0}},plugins:{datalabels:{anchor:"end",align:"top",formatter:Math.round,font:{weight:"bold"}}}},plugins:[ChartDataLabels],legend:{display:!1},tooltips:{callbacks:{label:t=>`${t.yLabel}: ${t.xLabel}`,title:()=>null}}}),a=t.parent().next(".small_chart").first(),n=$(document.createElement("img")),n.attr("src",e.toBase64Image()),n.css("width","100%"),a.html(n),t.parent().remove()})}}),$(function(){var t=localStorage.getItem("module"),e=localStorage.getItem("method");(t!=url.module||e!=url.method)&&localStorage.clear(),localStorage.setItem("module",url.module),localStorage.setItem("method",url.method),$(".form_content input, .form_content textarea").each(function(){var t=$(this).attr("name"),e=localStorage.getItem(t);e&&$(this).val(e),$(this).on("change",function(){var t=$(this).attr("name");t&&0>t.indexOf("[")&&localStorage.setItem(t,$(this).val())})}),$(".form_content form").on("submit",function(){localStorage.clear()})});;
